<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ping-Me — أداة فهرسة وروابط Ping</title>
  <meta name="description" content="أرسل HTTP Ping لما يصل إلى 200 رابط واعرض حالة كل رابط لحظيًا.">
  <link rel="preconnect" href="https://ping.anasrashed.com" />
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <header class="container">
    <h1>Ping-Me</h1>
    <p class="sub">أداة Ping للفهرسة — بدون IndexNow ✔️</p>
  </header>

  <main class="container card">
    <section class="controls">
      <label for="urls">الصق حتى ٢٠٠ رابط (كل رابط في سطر):</label>
      <textarea id="urls" placeholder="https://example.com/page-1
https://example.com/page-2
https://another.site/..." spellcheck="false"></textarea>

      <div class="row gap">
        <div class="info">
          <span id="count">0</span>/<span>200</span> رابط
        </div>
        <div class="grow"></div>
        <button id="startBtn" class="primary">ابدأ الإرسال</button>
        <button id="cancelBtn" class="secondary" disabled>إيقاف</button>
        <button id="exportBtn" class="ghost" disabled>تصدير CSV</button>
      </div>

      <div class="hint">
        يتم إرسال <strong>HEAD</strong> أولًا، وفي حال الرفض أو الخطأ يتم استخدام <strong>GET برينج 0-0</strong> لتقليل الباندويث. الحد الأقصى المتزامن: 10، المهلة لكل رابط: 10 ثوانٍ.
      </div>

      <div class="progress">
        <div id="bar" class="bar" style="width:0%"></div>
      </div>
      <div id="summary" class="summary">
        في الانتظار…
      </div>
    </section>

    <section>
      <div class="table-wrap">
        <table id="results">
          <thead>
            <tr>
              <th>#</th>
              <th>الرابط</th>
              <th>النتيجة</th>
              <th>الكود</th>
              <th>الطريقة</th>
              <th>الوقت (ms)</th>
              <th>الرابط النهائي</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer class="container foot">
    <span>المضيف: <a href="https://ping.anasrashed.com" target="_blank" rel="noopener">ping.anasrashed.com</a></span>
    <span>المشروع: <strong>ping-me</strong></span>
  </footer>

  <script src="/app.js" type="module"></script>
</body>
</html>
:root{
  --bg:#0c0f14;
  --card:#131823;
  --muted:#7c8aa5;
  --text:#e8eefc;
  --accent:#5ac8fa;
  --accent-2:#34c759;
  --danger:#ff453a;
  --warn:#ffd60a;
  --border:#1f2633;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;
  background:linear-gradient(180deg,#0b0f14,#0e1420 40%,#0a0f18);
  color:var(--text);
}
.container{width:min(1100px,92%); margin-inline:auto}
header{padding:32px 0 8px}
h1{margin:0;font-weight:800;letter-spacing:.4px}
.sub{color:var(--muted);margin-top:6px}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:14px;
  padding:22px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
}
.controls label{display:block;margin-bottom:10px}
textarea{
  width:100%; min-height:180px; resize:vertical;
  background:#0e1420; color:var(--text);
  border:1px solid var(--border); border-radius:10px;
  padding:14px; line-height:1.4; font-family:ui-monospace,Consolas,monospace;
}
.row{display:flex; align-items:center; margin-top:12px}
.gap>*{margin-inline:6px}
.grow{flex:1}
button{
  border:1px solid var(--border); background:#111824; color:var(--text);
  padding:10px 14px; border-radius:10px; cursor:pointer; transition:.15s transform,.15s opacity
}
button:hover{transform:translateY(-1px)}
button:disabled{opacity:.6; cursor:not-allowed}
.primary{background:var(--accent); color:#00131b; border-color:transparent; font-weight:700}
.secondary{background:#1a2332}
.ghost{background:transparent}
.hint{color:var(--muted); font-size:.9rem; margin-top:8px}
.progress{margin-top:14px; height:8px; background:#0e1420; border:1px solid var(--border); border-radius:999px; overflow:hidden}
.bar{height:100%; background:linear-gradient(90deg,var(--accent),#8be0ff)}
.summary{margin-top:10px; color:var(--muted)}

.table-wrap{margin-top:18px; overflow:auto; border:1px solid var(--border); border-radius:12px}
table{width:100%; border-collapse:collapse; font-size:.95rem}
th,td{padding:10px 12px; border-bottom:1px solid var(--border); text-align:start}
th{position:sticky; top:0; background:#141b28; z-index:2}
tbody tr:hover{background:#111826}
.status{
  font-weight:700; padding:.25rem .55rem; border-radius:999px; display:inline-block
}
.ok{background:rgba(52,199,89,.15); color:var(--accent-2); border:1px solid rgba(52,199,89,.35)}
.fail{background:rgba(255,69,58,.12); color:var(--danger); border:1px solid rgba(255,69,58,.35)}
.warn{background:rgba(255,214,10,.12); color:var(--warn); border:1px solid rgba(255,214,10,.35)}
.link{color:#9bd1ff; text-decoration:none}
.link:hover{text-decoration:underline}
.foot{display:flex; justify-content:space-between; align-items:center; color:var(--muted); padding:28px 0 40px}
@media (max-width:640px){
  .sub{font-size:.95rem}
  td:nth-child(7), th:nth-child(7){display:none}
}
/* Ping-Me Frontend - https://ping.anasrashed.com */
const textarea = document.getElementById('urls');
const countEl  = document.getElementById('count');
const startBtn = document.getElementById('startBtn');
const cancelBtn= document.getElementById('cancelBtn');
const exportBtn= document.getElementById('exportBtn');
const tbody    = document.querySelector('#results tbody');
const bar      = document.getElementById('bar');
const summary  = document.getElementById('summary');

let controller = null;
let results = [];
let total = 0, done = 0, okCount = 0, failCount = 0;

function sanitizeLines(text){
  return text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
}
function toAbsoluteHttp(url){
  try{
    // إذا لم تبدأ بـ http(s) سنفترض https://
    if(!/^https?:\/\//i.test(url)) url = 'https://' + url;
    const u = new URL(url);
    if(u.protocol !== 'http:' && u.protocol !== 'https:') return null;
    return u.toString();
  }catch{ return null; }
}
function updateCounter(){
  const lines = sanitizeLines(textarea.value);
  const urls = Array.from(new Set(lines.map(toAbsoluteHttp).filter(Boolean))).slice(0,200);
  countEl.textContent = String(urls.length);
  return urls;
}
textarea.addEventListener('input', updateCounter);

function resetUI(){
  results = [];
  total = done = okCount = failCount = 0;
  tbody.innerHTML = '';
  bar.style.width = '0%';
  summary.textContent = 'في الانتظار…';
  exportBtn.disabled = true;
}
function addRow(r, idx){
  const tr = document.createElement('tr');
  const statusClass = r.ok ? 'ok' : (r.status >= 300 && r.status < 400 ? 'warn' : 'fail');
  tr.innerHTML = `
    <td>${idx+1}</td>
    <td><a class="link" href="${escapeHtml(r.inputUrl)}" target="_blank" rel="noopener">${escapeHtml(truncate(r.inputUrl, 68))}</a></td>
    <td><span class="status ${statusClass}">${r.ok ? 'نجاح' : (r.status >= 300 && r.status < 400 ? 'تحويل' : 'فشل')}</span></td>
    <td>${r.status ?? '-'}</td>
    <td>${r.methodUsed}</td>
    <td>${r.timeMs ?? '-'}</td>
    <td>${r.finalUrl ? `<a class="link" href="${escapeHtml(r.finalUrl)}" target="_blank" rel="noopener">${escapeHtml(truncate(r.finalUrl, 60))}</a>` : '-'}</td>
  `;
  tbody.appendChild(tr);
}
function truncate(s, n){ return s.length>n? s.slice(0,n-1)+'…' : s; }
function escapeHtml(s){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

function setBusy(b){
  startBtn.disabled = b;
  cancelBtn.disabled = !b;
  textarea.disabled = b;
}

startBtn.addEventListener('click', async () => {
  const urls = updateCounter();
  if(urls.length === 0){ alert('أضف رابطًا واحدًا على الأقل. ❗'); return; }
  resetUI();
  total = urls.length;
  setBusy(true);

  controller = new AbortController();
  const signal = controller.signal;

  try{
    const resp = await fetch('/api/ping', {
      method: 'POST',
      headers: {'Content-Type':'application/json', 'Accept':'text/event-stream'},
      body: JSON.stringify({ urls }),
      signal
    });

    if(!resp.ok || !resp.body){
      throw new Error(`تعذر البدء: ${resp.status} ${resp.statusText}`);
    }

    // قراءة SSE يدويًا
    const reader = resp.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';

    while(true){
      const {value, done: readerDone} = await reader.read();
      if(readerDone) break;
      buffer += decoder.decode(value, {stream:true});

      let idx;
      while((idx = buffer.indexOf('\n\n')) !== -1){
        const eventChunk = buffer.slice(0, idx).trim();
        buffer = buffer.slice(idx + 2);
        handleSSE(eventChunk);
      }
    }
  }catch(err){
    if(signal.aborted){
      summary.textContent = 'تم الإيقاف من قبل المستخدم.';
    }else{
      summary.textContent = 'حدث خطأ أثناء الإرسال: ' + err.message;
    }
  }finally{
    setBusy(false);
    exportBtn.disabled = results.length === 0;
  }
});

cancelBtn.addEventListener('click', () => {
  if(controller){ controller.abort(); }
});

exportBtn.addEventListener('click', () => {
  if(!results.length) return;
  const headers = ['#','inputUrl','finalUrl','ok','status','statusText','methodUsed','timeMs'];
  const rows = results.map((r,i)=>[
    i+1,r.inputUrl,r.finalUrl||'',r.ok,r.status??'',r.statusText||'',r.methodUsed||'',r.timeMs??''
  ]);
  const csv = [headers, ...rows].map(r=>r.map(csvEscape).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `ping-results-${Date.now()}.csv`;
  a.click();
  URL.revokeObjectURL(a.href);
});
function csvEscape(val){
  const s = String(val??'');
  return /[,"\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
}

function handleSSE(chunk){
  // صيغة SSE: أسطر event: / data:
  let eventName = 'message';
  const lines = chunk.split('\n');
  let data = '';
  for(const line of lines){
    if(line.startsWith('event:')) eventName = line.slice(6).trim();
    else if(line.startsWith('data:')) data += line.slice(5).trim();
  }
  if(!data) return;

  try{
    const payload = JSON.parse(data);
    if(eventName === 'result'){
      results.push(payload);
      const idx = results.length - 1;
      addRow(payload, idx);
      done++;
      if(payload.ok) okCount++; else failCount++;
      const pct = Math.round((done/total)*100);
      bar.style.width = pct + '%';
      summary.textContent = `تم: ${done}/${total} — نجاح: ${okCount} — فشل: ${failCount}`;
    }else if(eventName === 'summary'){
      // تحديث ملخص نهائي إن لزم
      summary.textContent = `اكتمل الإرسال ✔️ — إجمالي: ${payload.total}, نجاح: ${payload.ok}, فشل: ${payload.fail}`;
    }
  }catch{}
}

// تحديث العدّاد مبدئيًا
updateCounter();
